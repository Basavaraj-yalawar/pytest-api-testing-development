name: API Automation (Pytest + Newman)

on:
  push:
    branches: [development]
  pull_request:
    branches: [development]

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  api-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------- PYTHON ----------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-html

      - name: Run Pytest API tests
        env:
          BASE_URL: https://jsonplaceholder.typicode.com
          AUTH_TOKEN: dummy-token
        run: |
          mkdir -p reports
          pytest -v -s \
            --html=reports/pytest-report.html \
            --self-contained-html

      # ---------- NODE / NEWMAN ----------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Newman + Reporter
        run: |
          npm install -g newman newman-reporter-htmlextra

      - name: Run Newman collection
        run: |
          mkdir -p newman-report
          newman run postman/CRUD_VAL.postman_collection.json \
            -e postman/JSONplaceholder.postman_environment.json \
            --reporters "cli,htmlextra" \
            --reporter-htmlextra-export "newman-report/newman.html"

      # ---------- ARTIFACTS ----------
      - name: Upload Pytest report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-report
          path: reports/pytest-report.html

      - name: Upload Newman report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-report
          path: newman-report/

      # ---------- JOB SUMMARY ----------
      - name: Generate Job Summary with Report Links
        if: always()
        run: |
          echo "## ðŸ“Š Test Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Available Reports:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ **Pytest Report**: [Download Artifact](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“® **Newman HTML Report**: [Download Artifact](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Newman Summary:" >> $GITHUB_STEP_SUMMARY
          if [ -f newman-report/newman.html ]; then
            echo "âœ“ Newman HTML report generated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš  Newman report not found" >> $GITHUB_STEP_SUMMARY
          fi

      # ---------- PUBLISH TO GITHUB PAGES (Optional) ----------
      - name: Deploy reports to GitHub Pages
        if: success() && github.ref == 'refs/heads/development' && github.event_name == 'push'
        continue-on-error: true
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./newman-report
          destination_dir: reports/${{ github.run_number }}
          keep_files: true

      - name: Comment PR with Report Links
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.runId;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            
            const comment = `## ðŸ§ª API Test Results
            
            ### ðŸ“Š Test Reports Available:
            - ðŸ [Pytest HTML Report](${runUrl}) - Check artifacts
            - ðŸ“® [Newman HTML Report](${runUrl}) - Check artifacts
            
            ### ðŸ“¥ Download Instructions:
            1. Click the links above
            2. Scroll to "Artifacts" section at the bottom
            3. Download \`newman-report\` or \`pytest-report\`
            
            > ðŸ’¡ **Tip**: Reports are also available in the [GitHub Pages](https://${context.repo.owner}.github.io/${context.repo.repo}/reports/${{ github.run_number }}/newman.html) (if enabled)
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
